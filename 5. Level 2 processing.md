As per the [the official FORCE documentation][1],

>  "The FORCE Level 2 Processing System (FORCE L2PS) generates
> harmonized, standardized, geometrically and radiometrically consistent
> Level 2 products with per-pixel quality information, i.e. Analysis
> Ready Data (ARD)."

- [Step 1: Generate the parameter file](#step-1--generate-the-parameter-file)
- [Step 2: Select the DEM, download it, and process it if required](#step-2--select-the-dem--download-it--and-process-it-if-required)
  * [Step 2.1 Select the DEM(s)](#step-21-select-the-dem-s-)
  * [Step 2.2 Download the DEM(s)](#step-22-download-the-dem-s-)
  * [Step 2.3 Process the DEM](#step-23-process-the-dem)
    + [A. Resampling](#a-resampling)
    + [B. Mosaicking the DEM](#b-mosaicking-the-dem)
- [Step 3: Create the directories for level 2 processing](#step-3--create-the-directories-for-level-2-processing)
- [Step 4: Edit the parameter to specify your requirements](#step-4--edit-the-parameter-to-specify-your-requirements)
- [Step 5: Run the module](#step-5--run-the-module)
- [Step 6: Troubleshooting](#step-6--troubleshooting)

<br>

## Step 1: Generate the parameter file 

Starting from this module, a parameter file is required for running the modules or submodules. [Here is the official FORCE documentation][2] for the parameter file generation program (`force-parameter`).

If using the example files from this workflow, you can skip this step.

<br>

*In Linux:*

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force force-parameter /data/parameter_level2.txt LEVEL2`

Output:
```
[sudo] password for GIS: 
An empty parameter file skeleton was written to
  /data/parameter_level2.txt
Note that all parameters need to be given, even though some may not be used
with your specific parameterization.
Parameterize according to your needs and run with
force-level2 /data/test_parameter_level2.txt
 or for a single image:
force-l2ps image /data/test_parameter_level2.txt
```
<br>

*In Windows:*

`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force force-parameter /home/docker/force/force/parameter_level2.txt LEVEL2`

Output:
```
An empty parameter file skeleton was written to
  /home/docker/force/force/parameter_level2.txt
Note that all parameters need to be given, even though some may not be used
with your specific parameterization.
Parameterize according to your needs and run with
force-level2 /home/docker/force/force/parameter_level2.txt
 or for a single image:
force-l2ps image /home/docker/force/force/parameter_level2.txt
```
<br><br>

## Step 2: Select the DEM, download it, and process it if required

<br>

### Step 2.1 Select the DEM(s)
<br><br>
DEM selection is a very important part of the parameterisation as it is used for both topographic and atmospheric corrections. So, For the DEM layer, **do thorough research on which DEM is better suited for your study region**, and whether it has any voids/holes to be filled. Among freely available DEMs, the highest resolution available is 30 m. But, one of them - ASTER has a lot of artifacts which instigates researchers to use a resampled 90 m SRTM instead (30 m is available for USA). 

### Step 2.2 Download the DEM(s)
<br><br>
The 90 m resolution SRTM DEM [can be downloaded here][3]. The other freely available DEMs are Alos World 3D (AW3D30 DSM)[ \[available from here\]][4], and Copernicus DEM (CopDEM) [See the Google Earth Engine (GEE) script below]. Depending on the version and source of the DEM, there could be voids or other issues. 

![enter image description here][5]

For example, as shown above, the AW3D30 v3.2 [downloaded from here][6] had voids in our study region of Siang Valley. But v4.2 downloaded from the JAXA website did not have any voids (was void-filled). You have to [first register][7] to access this DEM.

*GEE script for downloading Copernicus DEM*

```
//Upload the study area shapefile as an asset in GEE

//Load in the Copernicus 30 m resolution DEM (GLO-30) on to GEE
var dataset = ee.ImageCollection('COPERNICUS/DEM/GLO30');

//Check the size of the image collection
print('GLO-30 Collection size :',dataset.size())

//Set projection:
var demx = dataset.mosaic().setDefaultProjection('EPSG:4326', null, 30)

//Select the DEM elevation band
var dem = demx.select('DEM');

print('CRS:', dem.projection().crs());

//Load the region of interest
var roi = ee.FeatureCollection("projects/ee-paul_pop/assets/rectangleStudyArea");

//Clip the DEM to region of interest 
var elev = dem.clip(roi);

//Visualise the elevation
var palettes = require('users/gena/packages:palettes');
var visParam = {
  crs: 'EPSG:4326',
  min: 100,
  max: 5020,
  palette: palettes.kovesi.linear_kry_5_98_c75[7]
};
Map.addLayer(elev, visParam, 'DEM')
Map.centerObject(elev, 8);

//Define no data value, then unmask the merged and clipped image and supply the value to it
var noDataVal = -9999;
var unmaskedImage = elev.unmask({value: noDataVal, sameFootprint: false});

//Save image to drive
Export.image.toDrive({
  image: unmaskedImage,
  region: roi,
  description: 'GLO30',
  crs: "EPSG:4326",
  scale: 30,
  maxPixels: 1e13,  //Since it's a large area and contains a lot of pixels
  fileFormat: 'GeoTIFF',
  formatOptions: {
    noData: noDataVal
  }
});
```
<br>

### Step 2.3 Process the DEM
<br><br>

#### A. Resampling

The ~90 m resolution SRTM imagery can be interpolated/resampled to 30 m resolution, and downloaded to Google Drive by running the following GEE script:

```
// Load the void-filled 90 m resolution SRTM DEM layer downloaded from the https://srtm.csi.cgiar.org/srtmdata/
var srtm1 = ee.Image("projects/ee-paul_pop/assets/DEM/srtm_55_07");
var srtm2 = ee.Image("projects/ee-paul_pop/assets/DEM/srtm_56_07");

print('CRS:', srtm1.projection().crs());
print('CRS:', srtm2.projection().crs());

// Resample the two srtm imageries
var reproj_srtm1 = srtm1.resample('bicubic').reproject({
  crs: "EPSG:4326",
  scale: 30,
});

var reproj_srtm2 = srtm2.resample('bicubic').reproject({
  crs: "EPSG:4326",
  scale: 30,
});

/*// Another way to change crs:
var reprojected = srtm[x].resample('bicubic').reproject({
  crs: elevation.projection().crs(),
  scale: 30,
});*/

// Display the reprojected and resampled SRTM data
Map.addLayer(reproj_srtm1, {min: 100, max: 5020}, 'SRTM1 Reprojected and Resampled');
Map.centerObject(reproj_srtm1, 8);

Map.addLayer(reproj_srtm2, {min: 100, max: 5020}, 'SRTM2 Reprojected and Resampled');
Map.centerObject(reproj_srtm2, 8);

//Combine them both
var merged = ee.ImageCollection.fromImages([reproj_srtm1, reproj_srtm2]).mosaic()

print('CRS:', merged.projection().crs());

//Load the region of interest (the exact boundary of the Siang study area)
var roi = ee.FeatureCollection("projects/ee-paul_pop/assets/siang");

//Clip the DEM to region of interest (don't use "select('b1')" i.e. var elevation = merged.select('b1').clip(roi);
//since the image only contains one band and it may mess up the output)

var elevation = merged.clip(roi);

// Get the projection information for the clipped and merged 90 m void-filled SRTM DEM
print('CRS:', elevation.projection().crs());
//It should show "CRS: <break> EPSG:4326" in JSON which is the coordinate system we desire 

/*IMPORTANT: Order of arguments is very important in GEE as my attempt at first merging the void-filled 90 m
DEM and clipping them according to the Siang study area resulted in this error (when saving the final resampled 
reprojected output): "Error: Projection error: Unable to compute intersection of geometries in projections EPSG:4326:
affine [1.0, 0.0, 0.0, 0.0, 1.0, 0.0] and EPSG:4326: affine [1.0, 0.0, 0.0, 0.0, 1.0, 0.0] (abstract projection). 
(Error code: 3)".   This error couldn't be resolved despite various methods (including selecting a rectangular study
area with ony four vertices). So, always the resampling and reprojection of individual imagery needs to
be done before merging them and clipping them to the study region.*/

// Export the individual interpolated images (if needed)
Export.image.toDrive({
  image: reproj_srtm1,
  description: 'spline_interpolated_srtm1',
  crs: "EPSG:4326",
  scale: 30,
  maxPixels: 1e13  //Since it's a large area and contains a lot of pixels
});

Export.image.toDrive({
  image: reproj_srtm2,
  description: 'spline_interpolated_srtm2',
  crs: "EPSG:4326",
  scale: 30,
  maxPixels: 1e13  //Since it's a large area and contains a lot of pixels
});

/*Export the interpolated merged and clipped image.
Note that without the "region: roi" argument, it will download a imagery with 0 data, but with it, it will 
result in no-data values outside the exact study area, but within the rectangle bounding the roi
being shown as 0 (not important since it will be clipped for thetopographic correction
step. However, it can be rectified by specifying no data value as below*/

//Define no data value, then unmask the merged and clipped image and supply the value to it:
var noDataVal = -9999;
var unmaskedImage = elevation.unmask({value: noDataVal, sameFootprint: false});

Export.image.toDrive({
  image: unmaskedImage,
  region: roi,
  description: 'spline_interpolated_srtm_new',
  crs: "EPSG:4326",
  scale: 30,
  maxPixels: 1e13,  //Since it's a large area and contains a lot of pixels
  fileFormat: 'GeoTIFF',
  formatOptions: {
    noData: noDataVal
  }
});

//Visualise the elevation (note that this changes the projection to maps mercator so that it is visible in GEE map.
//So, do it only after saving the image)
var palettes = require('users/gena/packages:palettes');
var visParam = {
  crs: 'EPSG:4326',
  min: 100,
  max: 5020,
  palette: palettes.kovesi.linear_kry_5_98_c75[7]
};
Map.addLayer(elevation, visParam, 'Elevation');

/*Saving srtm1 to drive took nearly 8 minutes (started 2025-03-24 17:16:49 +0530; 561.2390 EECU-seconds)
and saving srtm2 took 9 min (started 2025-03-24 17:35:48 +0530; 645.2406 EECU-seconds) the first time and 
7 min (started 2025-03-25 11:17:41 +0530; 528.0871 EECU-seconds) the second time (showing the slightly variable time 
duration of doing the same process). Saving srtm(merged and clipped) which is only around 5% of the file size took 
11 minutes (started 2025-03-25 10:42:17 +0530; 102.8910 EECU-seconds) showing that time taken is not dependent on 
file size, but the processes involved, although computing seconds for the Earth Engine (EECU) was itself low. 
After defining no data value, it took 11 min (started 2025-03-25 12:16:52 +0530; 64.8410 EECU-seconds). */
```
<br>

#### B. Mosaicking the DEM

Prepare a mosaic of the void-filled srtm data (interpolated using the previous GEE script) for use in the radiometric corrections. In the following, if there are multiple tiles of the downloaded DEM, put them under the respective folder. For example, if multiple SRTM DEM files cover the study area, then under the folder 'dem' (or 'dem2' or 'dem3' created under the 'force' directory, create a folder titled 'srtm', and put the multiple SRTM files.

<br>

***i. SRTM***

<br>

**Step B.i.1:** First prepare the txt file using the following (where srtm is the folder containing the dem imagery to be mosaicked and turned into a virtual raster layer):

<br>

*In Linux:*

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force sh -c "find /data/dem/srtm -name '*.tif' | tee /data/dem/srtm.txt"`

`[sudo] password for GIS:` 

Output:

```
/data/dem/srtm/spline_interpolated_srtm1.tif
/data/dem/srtm/spline_interpolated_srtm2.tif
```
<br>

*In Windows:*

`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force sh -c "find /home/docker/force/force/dem/srtm -name '*.tif' | tee /home/docker/force/force/dem/srtm.txt"`

Output:
```
/home/docker/force/force/dem/spline_interpolated_srtm1.tif
/home/docker/force/force/dem/spline_interpolated_srtm2.tif
```

<br>

**Step B.i.2:** Create the virtual mosaic

<br>

*In Linux:*

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force gdalbuildvrt -input_file_list /data/dem/srtm.txt /data/dem/srtm.vrt`

Ouput:

```
0...10...20...30...40...50...60...70...80...90...100 - done.
```
<br>

*In Windows:*


`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force gdalbuildvrt -input_file_list /home/docker/force/force/dem/srtm.txt /home/docker/force/force/dem/srtm.vrt`

Output:
```
Result:
0...10...20...30...40...50...60...70...80...90...100 - done.
```

<br>

**Step B.i.3:** View the result:

<br>

*In Linux:*

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force cat /data/dem/srtm.vrt`

Output:

```
<VRTDataset rasterXSize="37112" rasterYSize="18564">
  <SRS dataAxisToSRSAxisMapping="2,1">GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AXIS["Latitude",NORTH],AXIS["Longitude",EAST],AUTHORITY["EPSG","4326"]]</SRS>
  <GeoTransform>  8.9999333707025684e+01,  2.6949458523585647e-04,  0.0000000000000000e+00,  3.0002023690552193e+01,  0.0000000000000000e+00, -2.6949458523585647e-04</GeoTransform>
  <VRTRasterBand dataType="Int16" band="1">
    <Metadata>
      <MDI key="STATISTICS_APPROXIMATE">YES</MDI>
      <MDI key="STATISTICS_MAXIMUM">7032</MDI>
      <MDI key="STATISTICS_MEAN">2331.397758809</MDI>
      <MDI key="STATISTICS_MINIMUM">0</MDI>
      <MDI key="STATISTICS_STDDEV">1780.0168049611</MDI>
      <MDI key="STATISTICS_VALID_PERCENT">100</MDI>
    </Metadata>
    <ColorInterp>Gray</ColorInterp>
    <SimpleSource>
      <SourceFilename relativeToVRT="1">srtm/spline_interpolated_srtm1.tif</SourceFilename>
      <SourceBand>1</SourceBand>
      <SourceProperties RasterXSize="18558" RasterYSize="18562" DataType="Int16" BlockXSize="256" BlockYSize="256" />
      <SrcRect xOff="0" yOff="0" xSize="18558" ySize="18562" />
      <DstRect xOff="0" yOff="2" xSize="18558" ySize="18562" />
    </SimpleSource>
    <SimpleSource>
      <SourceFilename relativeToVRT="1">srtm/spline_interpolated_srtm2.tif</SourceFilename>
      <SourceBand>1</SourceBand>
      <SourceProperties RasterXSize="18559" RasterYSize="18564" DataType="Int16" BlockXSize="256" BlockYSize="256" />
      <SrcRect xOff="0" yOff="0" xSize="18559" ySize="18564" />
      <DstRect xOff="18553" yOff="0" xSize="18559" ySize="18564" />
    </SimpleSource>
  </VRTRasterBand>
</VRTDataset>
```
<br>

*In Windows:*

`podman run -it -v "C:\Users\Kedaravindan Bhaskar:/home/docker/force" davidfrantz/force cat /home/docker/force/force/dem/srtm.vrt`

Output:

```
<VRTDataset rasterXSize="37112" rasterYSize="18564">
  <SRS dataAxisToSRSAxisMapping="2,1">GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AXIS["Latitude",NORTH],AXIS["Longitude",EAST],AUTHORITY["EPSG","4326"]]</SRS>
  <GeoTransform>  8.9999333707025684e+01,  2.6949458523585647e-04,  0.0000000000000000e+00,  3.0002023690552193e+01,  0.0000000000000000e+00, -2.6949458523585647e-04</GeoTransform>
  <VRTRasterBand dataType="Int16" band="1">
    <ColorInterp>Gray</ColorInterp>
    <SimpleSource>
      <SourceFilename relativeToVRT="1">srtm/spline_interpolated_srtm1.tif</SourceFilename>
      <SourceBand>1</SourceBand>
      <SourceProperties RasterXSize="18558" RasterYSize="18562" DataType="Int16" BlockXSize="256" BlockYSize="256" />
      <SrcRect xOff="0" yOff="0" xSize="18558" ySize="18562" />
      <DstRect xOff="0" yOff="2" xSize="18558" ySize="18562" />
    </SimpleSource>
    <SimpleSource>
      <SourceFilename relativeToVRT="1">srtm/spline_interpolated_srtm2.tif</SourceFilename>
      <SourceBand>1</SourceBand>
      <SourceProperties RasterXSize="18559" RasterYSize="18564" DataType="Int16" BlockXSize="256" BlockYSize="256" />
      <SrcRect xOff="0" yOff="0" xSize="18559" ySize="18564" />
      <DstRect xOff="18553" yOff="0" xSize="18559" ySize="18564" />
    </SimpleSource>
  </VRTRasterBand>
</VRTDataset>
```

Similarly, it can done for the other DEMs depending on which or how many different DEMs you will be using to carry out various radiometric corrections (atmospheric and topographic corrections).

<br>

***ii. AW3D30***

<br>

**Step B.ii.1:** Prepare the txt file using the following (where alos is the folder containing the dem imagery to be mosaicked and turned into a virtual raster layer). NOTE: that the downloaded zip file from the JAXA website will contain three tif files for each tile, but only the one end with DSM (e.g. 'ALPSMLC30_N028E094_DSM.tif') is necessary. So, those files should be moved under the folder "alos" under "dem2" after unzipping:

<br>

*In Linux:*

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force sh -c "find /data/dem2/alos -name '*.tif' | tee /data/dem2/alos.txt"`

Output:
```
/data/dem2/alos/ALPSMLC30_N028E094_DSM.tif
/data/dem2/alos/ALPSMLC30_N027E095_DSM.tif
/data/dem2/alos/ALPSMLC30_N028E095_DSM.tif
/data/dem2/alos/ALPSMLC30_N028E093_DSM.tif
/data/dem2/alos/ALPSMLC30_N029E094_DSM.tif
/data/dem2/alos/ALPSMLC30_N027E094_DSM.tif
/data/dem2/alos/ALPSMLC30_N029E095_DSM.tif
```
<br>

*In Windows:*

`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force sh -c "find /home/docker/force/force/dem2/alos -name '*.tif' | tee /home/docker/force/force/dem2/alos.txt"`

Output:

```
/home/docker/force/force/dem2/alos/ALPSMLC30_N027E094_DSM.tif
/home/docker/force/force/dem2/alos/ALPSMLC30_N027E095_DSM.tif
/home/docker/force/force/dem2/alos/ALPSMLC30_N028E093_DSM.tif
/home/docker/force/force/dem2/alos/ALPSMLC30_N028E094_DSM.tif
/home/docker/force/force/dem2/alos/ALPSMLC30_N028E095_DSM.tif
/home/docker/force/force/dem2/alos/ALPSMLC30_N029E094_DSM.tif
/home/docker/force/force/dem2/alos/ALPSMLC30_N029E095_DSM.tif
```
<br>

**Step B.ii.2:** Create the virtual mosaic:

<br>

*In Linux:*

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force gdalbuildvrt -input_file_list /data/dem2/alos.txt /data/dem2/alos.vrt`

Output:

```
0...10...20...30...40...50...60...70...80...90...100 - done.
```

<br>

*In Windows:*

`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force gdalbuildvrt -input_file_list /home/docker/force/force/dem2/alos.txt /home/docker/force/force/dem2/alos.vrt`

Output:

```
0...10...20...30...40...50...60...70...80...90...100 - done.
```
<br>

**Step B.ii.3:** View the result:

<br>

*In Linux:*

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force cat /data/dem2/alos.vrt`

Output:
```
<VRTDataset rasterXSize="10800" rasterYSize="10800">
  <SRS dataAxisToSRSAxisMapping="2,1">GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AXIS["Latitude",NORTH],AXIS["Longitude",EAST],AUTHORITY["EPSG","4326"]]</SRS>
  <GeoTransform>  9.3000000000000000e+01,  2.7777777777777778e-04,  0.0000000000000000e+00,  3.0000000000000000e+01,  0.0000000000000000e+00, -2.7777777777777778e-04</GeoTransform>
  <VRTRasterBand dataType="Int16" band="1">
    <NoDataValue>-9999</NoDataValue>
    <ColorInterp>Gray</ColorInterp>
    <ComplexSource>
      <SourceFilename relativeToVRT="1">alos/ALPSMLC30_N028E094_DSM.tif</SourceFilename>
      <SourceBand>1</SourceBand>
      <SourceProperties RasterXSize="3600" RasterYSize="3600" DataType="Int16" BlockXSize="3600" BlockYSize="1" />
      <SrcRect xOff="0" yOff="0" xSize="3600" ySize="3600" />
      <DstRect xOff="3600" yOff="3600" xSize="3600" ySize="3600" />
      <NODATA>-9999</NODATA>
    </ComplexSource>
    <ComplexSource>
      <SourceFilename relativeToVRT="1">alos/ALPSMLC30_N027E095_DSM.tif</SourceFilename>
      <SourceBand>1</SourceBand>
      <SourceProperties RasterXSize="3600" RasterYSize="3600" DataType="Int16" BlockXSize="3600" BlockYSize="1" />
      <SrcRect xOff="0" yOff="0" xSize="3600" ySize="3600" />
      <DstRect xOff="7200" yOff="7200" xSize="3600" ySize="3600" />
      <NODATA>-9999</NODATA>
    </ComplexSource>
    <ComplexSource>
      <SourceFilename relativeToVRT="1">alos/ALPSMLC30_N028E095_DSM.tif</SourceFilename>
      <SourceBand>1</SourceBand>
      <SourceProperties RasterXSize="3600" RasterYSize="3600" DataType="Int16" BlockXSize="3600" BlockYSize="1" />
      <SrcRect xOff="0" yOff="0" xSize="3600" ySize="3600" />
      <DstRect xOff="7200" yOff="3600" xSize="3600" ySize="3600" />
      <NODATA>-9999</NODATA>
    </ComplexSource>
    <ComplexSource>
      <SourceFilename relativeToVRT="1">alos/ALPSMLC30_N028E093_DSM.tif</SourceFilename>
      <SourceBand>1</SourceBand>
      <SourceProperties RasterXSize="3600" RasterYSize="3600" DataType="Int16" BlockXSize="3600" BlockYSize="1" />
      <SrcRect xOff="0" yOff="0" xSize="3600" ySize="3600" />
      <DstRect xOff="0" yOff="3600" xSize="3600" ySize="3600" />
      <NODATA>-9999</NODATA>
    </ComplexSource>
    <ComplexSource>
      <SourceFilename relativeToVRT="1">alos/ALPSMLC30_N029E094_DSM.tif</SourceFilename>
      <SourceBand>1</SourceBand>
      <SourceProperties RasterXSize="3600" RasterYSize="3600" DataType="Int16" BlockXSize="3600" BlockYSize="1" />
      <SrcRect xOff="0" yOff="0" xSize="3600" ySize="3600" />
      <DstRect xOff="3600" yOff="0" xSize="3600" ySize="3600" />
      <NODATA>-9999</NODATA>
    </ComplexSource>
    <ComplexSource>
      <SourceFilename relativeToVRT="1">alos/ALPSMLC30_N027E094_DSM.tif</SourceFilename>
      <SourceBand>1</SourceBand>
      <SourceProperties RasterXSize="3600" RasterYSize="3600" DataType="Int16" BlockXSize="3600" BlockYSize="1" />
      <SrcRect xOff="0" yOff="0" xSize="3600" ySize="3600" />
      <DstRect xOff="3600" yOff="7200" xSize="3600" ySize="3600" />
      <NODATA>-9999</NODATA>
    </ComplexSource>
    <ComplexSource>
      <SourceFilename relativeToVRT="1">alos/ALPSMLC30_N029E095_DSM.tif</SourceFilename>
      <SourceBand>1</SourceBand>
      <SourceProperties RasterXSize="3600" RasterYSize="3600" DataType="Int16" BlockXSize="3600" BlockYSize="1" />
      <SrcRect xOff="0" yOff="0" xSize="3600" ySize="3600" />
      <DstRect xOff="7200" yOff="0" xSize="3600" ySize="3600" />
      <NODATA>-9999</NODATA>
    </ComplexSource>
  </VRTRasterBand>
</VRTDataset>

```

<br>

*In Windows:*

`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force cat /home/docker/force/force/dem2/alos.vrt`

Output:
```
Same as in Linux
```
<br>

***CopDEM***

The CopDEM has only one tile covering my entire area. So, a subfolder to keep all the files is not necessary.

<br>

**Step B.iii.1:** Prepare the txt file using the following (where dem3 is the folder containing the dem imagery to be turned into a virtual raster layer):

<br>

*In Linux:*

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force sh -c "find /data/dem3 -name '*.tif' | tee /data/dem3/glo30.txt"`

Output:
```
/data/dem3/GLO30.tif
```
<br>

*In Windows:*

`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force sh -c "find /home/docker/force/force/dem3 -name '*.tif' | tee /home/docker/force/force/dem3/glo30.txt"`

Output:

```
/home/docker/force/force/dem3/GLO30.tif
```

<br>

**Step B.iii.2:** Create the virtual raster tile:

<br>

*In Linux:*

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force gdalbuildvrt -input_file_list /data/dem3/glo30.txt /data/dem3/glo30.vrt`

Output:
```
0...10...20...30...40...50...60...70...80...90...100 - done.
```
<br>

*In Windows:*

`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force gdalbuildvrt -input_file_list /home/docker/force/force/dem3_test/glo30.txt /home/docker/force/force/dem3_test/glo30.vrt`

Output:

```
0...10...20...30...40...50...60...70...80...90...100 - done.
```
<br>

**Step B.iii.3:** View the result:

<br>

*In Linux:*

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force cat /data/dem3/glo30.vrt`

Output:
```
<VRTDataset rasterXSize="6309" rasterYSize="6866">
  <SRS dataAxisToSRSAxisMapping="2,1">GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AXIS["Latitude",NORTH],AXIS["Longitude",EAST],AUTHORITY["EPSG","4326"]]</SRS>
  <GeoTransform>  9.3957400680384708e+01,  2.6949458523585647e-04,  0.0000000000000000e+00,  2.9347960332184769e+01,  0.0000000000000000e+00, -2.6949458523585647e-04</GeoTransform>
  <VRTRasterBand dataType="Float32" band="1">
    <NoDataValue>-9999</NoDataValue>
    <ColorInterp>Gray</ColorInterp>
    <ComplexSource>
      <SourceFilename relativeToVRT="1">GLO30.tif</SourceFilename>
      <SourceBand>1</SourceBand>
      <SourceProperties RasterXSize="6309" RasterYSize="6866" DataType="Float32" BlockXSize="256" BlockYSize="256" />
      <SrcRect xOff="0" yOff="0" xSize="6309" ySize="6866" />
      <DstRect xOff="0" yOff="0" xSize="6309" ySize="6866" />
      <NODATA>-9999</NODATA>
    </ComplexSource>
  </VRTRasterBand>
</VRTDataset>
```
<br>

*In Windows:*

`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force cat /home/docker/force/force/dem3/glo30.vrt`

Output:

```
<VRTDataset rasterXSize="6309" rasterYSize="6866">
  <SRS dataAxisToSRSAxisMapping="2,1">GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AXIS["Latitude",NORTH],AXIS["Longitude",EAST],AUTHORITY["EPSG","4326"]]</SRS>
  <GeoTransform>  9.3957400680384708e+01,  2.6949458523585647e-04,  0.0000000000000000e+00,  2.9347960332184769e+01,  0.0000000000000000e+00, -2.6949458523585647e-04</GeoTransform>
  <VRTRasterBand dataType="Float32" band="1">
    <Metadata>
      <MDI key="STATISTICS_APPROXIMATE">YES</MDI>
      <MDI key="STATISTICS_MAXIMUM">4923.1069335938</MDI>
      <MDI key="STATISTICS_MEAN">1830.5229376888</MDI>
      <MDI key="STATISTICS_MINIMUM">116.1155166626</MDI>
      <MDI key="STATISTICS_STDDEV">1445.4528669912</MDI>
      <MDI key="STATISTICS_VALID_PERCENT">100</MDI>
    </Metadata>
    <NoDataValue>-9999</NoDataValue>
    <ColorInterp>Gray</ColorInterp>
    <ComplexSource>
      <SourceFilename relativeToVRT="1">GLO30.tif</SourceFilename>
      <SourceBand>1</SourceBand>
      <SourceProperties RasterXSize="6309" RasterYSize="6866" DataType="Float32" BlockXSize="256" BlockYSize="256" />
      <SrcRect xOff="0" yOff="0" xSize="6309" ySize="6866" />
      <DstRect xOff="0" yOff="0" xSize="6309" ySize="6866" />
      <NODATA>-9999</NODATA>
    </ComplexSource>
  </VRTRasterBand>
</VRTDataset>
```
<br><br>

## Step 3: Create the directories for level 2 processing
<br><br>

See the [FORCE level-2 file parameter explanations][8] to understand what each of the folder is for.

*In Linux:*

Create the output directory:<br>
`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force mkdir /data/dir_level2` 

```
NOTE: Running such a mkdir commands twice will result in this:  “mkdir: cannot create directory '/data/dir_level2': File exists”
```
Create a log directory ([see FORCE documentation][9]):<br>
`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force mkdir /data/dir_log_level2`

Create a provenance directory ([see FORCE documentation][10]):<br>
`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force mkdir /data/dir_provenance_level2`

Create a temporary directory:<br>
`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force mkdir /data/dir_temp_level2`

<br><br>
*In Windows:*

Create the output directory:<br>
`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force mkdir /home/docker/force/force/dir_level2` 

Create a log directory:<br>
`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force mkdir /home/docker/force/force/dir_log_level2`

Create a provenance directory:<br>
`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force mkdir /home/docker/force/force/dir_provenance_level2`

Create a temporary directory:<br>
`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force mkdir /home/docker/force/force/dir_temp_level2`

<br><br>

## Step 4: Edit the parameter to specify your requirements

Open the generated "parameter_level2.txt" file from Step 1 and then specify all the parameters. An example file can be found under the Files section of this "Level 2 Processing section".

There are so many options for customisation. The parameter file itself states the options. Do thorough research on the options to select the correct parameters for your study area, objectives of research, and well as system resources. For example, consider the coordinate system parameter.

*Selection of projection system*

The PROJECTION was chosen as [EPSG:7755][11] since it is covers India (including Arunachal Pradesh where Siang valley is located) and is WGS based (best to use WGS84 as datum instead of UTM; see [discussion here][12]. The WKT file for the same has been added there in the parameter file:
```
PROJCS["WGS 84 / India NSF LCC",GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Lambert_Conformal_Conic_2SP"],PARAMETER["latitude_of_origin",24],PARAMETER["central_meridian",80],PARAMETER["standard_parallel_1",12.472955],PARAMETER["standard_parallel_2",35.1728044444444],PARAMETER["false_easting",4000000],PARAMETER["false_northing",4000000],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","7755"]]
```

One can also use https://projectionwizard.org/ for selecting a projection with least distortions. 

The WKT text can be collected from QGIS:
```
Right click and select “Properties” of any file> “Assigned Coordinate Reference System”> “Coordinate Reference System Selector” > Search for “EPSG:7755” under the “Filter” search bar> Bottom left panel has “WKT” after “Properties”
```
Alternatively, one can get this information from https://epsg.io/?q= by searching for EPSG:7755

<br><br>
## Step 5: Run the module

<br>

*In Linux:*

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force force-level2 /data/parameter2_level2.txt`

Output:

```
44 images enqueued. Start processing with 7 NPROC

Computers / CPU cores / Max jobs to run
1:local / 16 / 7

Computer:jobs running/jobs completed/%of started jobs/Average seconds to complete
ETA: 0s Left: 0 AVG: 44.82s  local:0/44/100%/51.1s 
```
<br>

*In Windows:*

`podman run -it --user root -v "C:\Users\GIS:/home/docker/force" davidfrantz/force force-level2 /home/docker/force/force/parameter_level2.txt`

The --user root is used to solve permission issues

<br><br>

## Step 6: Troubleshooting

This section will cover the common pitfalls or errors that can pop up while carring out level 2 processing.

<br>

*Example A*

*Warning:* The following will happen if the folder containing the DEM images are not unzipped (when copied form elsewhere or from another system). This is because the filepath within in the vrt mosaic is not correctly detected (since the ‘alos’ (or 'srtm') folder is within the zipped folder). The **boldened** portion in the following log file shows this error:

From dir_log_level2:

```
FORCE Level 2 Processing System
-----------------------------------------------------------

Start of processing: 2025-07-10 12:00:53
Image: /data/level1/LC08_L1TP_135040_20240107_20240122_02_T1.tar
Unpacking tar container successful

Start core processing
-----------------------------------------------------------

*dc:   0.00%. wc:   -nan%. sc:   -nan%. cc: 100.00%.* Skip. Processing time: 00 mins 13 secs

-----------------------------------------------------------
Core processing signaled DONE

End of processing: 2025-07-10 12:01:08
May the FORCE be with you!
```

While the message displays 'Core processing signaled DONE', instead of FAILED, it still has not processed it properly because of the above-mentioned error.

<br>

*Example B*

The force-level2 module can sometimes fail for several imagery. For example, see below (this is the queue file from the Data querying and Download procedure):
```
/home/docker/force/force/level1/LC08_L1TP_134040_20241217_20241227_02_T1.tar DONE
/home/docker/force/force/level1/LC08_L1TP_134040_20241201_20241203_02_T1.tar DONE
/home/docker/force/force/level1/LC08_L1TP_134041_20241115_20241119_02_T1.tar FAIL
/home/docker/force/force/level1/LC08_L1TP_134041_20241201_20241203_02_T1.tar DONE
/home/docker/force/force/level1/LC08_L1TP_134041_20241217_20241227_02_T1.tar DONE
/home/docker/force/force/level1/LC08_L1TP_135040_20240107_20240122_02_T1.tar FAIL
/home/docker/force/force/level1/LC08_L1TP_135040_20241224_20241228_02_T1.tar FAIL
.
.
.
```
In this case, three images failed to get processed properly. So the queue status has to be changed.

*In Linux:*

One way to make it work in Linux:

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force sed -i 's/FAIL/QUEUED/' /data/queue.txt`

Here the word FAIL is being turned to QUEUED. When the image processing is skipped due to non-reading of the cloud-cover percent, it changes to DONE instead of FAIL. So, change it from DONE to QUEUED:

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force sed -i 's/DONE/QUEUED/' /data/queue.txt`

*In Windows:*

One way to make it work (a tiny bit risky, security wise since the command is run as root):

`podman run -it --user root -v "C:\Users\GIS:/home/docker/force" davidfrantz/force sed -i 's/FAIL/QUEUED/' /home/docker/force/force/queue.txt`

AND

`podman run -it --user root -v "C:\Users\GIS:/home/docker/force" davidfrantz/force sed -i 's/DONE/QUEUED/' /home/docker/force/force/queue.txt`

Another more complicated way to do this in Windows is to redirect the output to a new file and then replace the original (and then removing the intermediate tmp file):

`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force bash -c "sed 's/FAIL/QUEUED/' /home/docker/force/force/queue.txt > /home/docker/force/force/queue.txt.tmp && mv /home/docker/force/force/queue.txt.tmp /home/docker/force/force/queue.txt"`

Ouput:
```
mv: replace '/home/docker/force/force/queue.txt', overriding mode 0555 (r-xr-xr-x)?
```
Remove the .tmp file as mentioned above:
`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force rm /home/docker/force/force/queue.txt.tmp`

**WHAT NOT TO USE:**

Changing the queue status for reattempt when force-level2 fails, can fail when using the following command in Windows ([this code from the offical FORCE documentation][13] is for Linux systems). So don't repurpose it for Windows. It won't work:
 
`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force sed -i 's/FAIL/QUEUED/' /home/docker/force/force/queue.txt`

Output:
```
sed: preserving permissions for '/home/docker/force/force/sedeDxfoj': Operation not permitted
```

I also tried elevating privilege for Podman. Didn’t work either:

`podman run --privileged -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force sed -i 's/FAIL/QUEUED/' /home/docker/force/force/queue.txt`

Output:

Output:
```
sed: preserving permissions for '/home/docker/force/force/sedVRBWQg': Operation not permitted
```


  [1]: https://force-eo.readthedocs.io/en/latest/components/lower-level/level2/index.html
  [2]: https://force-eo.readthedocs.io/en/latest/components/auxilliary/parameter.html#force-parameter
  [3]: https://srtm.csi.cgiar.org/srtmdata/
  [4]: https://www.eorc.jaxa.jp/ALOS/en/aw3d30/data/index.htm
  [5]: https://i.ibb.co/LzLGSRsZ/image.png
  [6]: https://portal.opentopography.org/datasetMetadata?otCollectionID=OT.112016.4326.2
  [7]: https://www.eorc.jaxa.jp/ALOS/en/dataset/aw3d30/registration.htm
  [8]: https://force-eo.readthedocs.io/en/latest/components/lower-level/level2/param.html
  [9]: https://force-eo.readthedocs.io/en/latest/components/lower-level/level2/format.html#logfile
  [10]: https://force-eo.readthedocs.io/en/latest/components/lower-level/level2/format.html#provenance
  [11]: https://epsg.io/7755
  [12]: https://gis.stackexchange.com/questions/71931/choosing-geographical-coordinate-system-and-projected-coordinate-system-for-indi
  [13]: https://force-eo.readthedocs.io/en/latest/components/lower-level/level1/queue.html
