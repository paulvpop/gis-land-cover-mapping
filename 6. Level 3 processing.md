> Level 3 processing produces highly Analysis Ready Data (HARD). This
> includes the Best Available Pixel (BAPs)/pixel-based compositing which
> stitches together the best quality pixels from across the time period
> of study and produces an image that can be used for land cover
> prediction. This also includes the Spectral Temporal Metrics. As
> written [in the official FORCE documentation][1] "Spectral Temporal Metrics
> (or simply STMs) are band-wise descriptive statistics, which summarize
> reflectance (or an index derived thereof) within a defined time
> period. This can be the annual mean, standard deviation or median.
> Before calculating the statistics, the data is quality filtered, e.g.
> clouds are removed."

<br>

#### Table of contents

- [A. Pixel-based compositing](#a-pixel-based-compositing)
  * [Step A.1: Create the parameter file for level 3 processing](#step-a1--create-the-parameter-file-for-level-3-processing)
  * [Step A.2: Create the output and other directories for level 3 processing](#step-a2--create-the-output-and-other-directories-for-level-3-processing)
  * [Step A.3: Fill up the parameter file](#step-a3--fill-up-the-parameter-file)
  * [Step A.4: Run the level 3 processing module](#step-a4--run-the-level-3-processing-module)
- [B. Time series analysis/Spectral Temporal Metrics](#b-time-series-analysis-spectral-temporal-metrics)
  * [Step B.1: Create the parameter file for level 3 processing](#step-b1--create-the-parameter-file-for-level-3-processing)
  * [Step B.2: Create the output and other directories for level 3 processing](#step-b2--create-the-output-and-other-directories-for-level-3-processing)
  * [Step B.3: Fill up the parameter file](#step-b3--fill-up-the-parameter-file)
  * [Step B.4: Run the level 3 processing module](#step-b4--run-the-level-3-processing-module)
- [Troubleshooting](#troubleshooting)

<br>

## A. Pixel-based compositing

<br>

### Step A.1: Create the parameter file for level 3 processing

If using the example "Files" from this workflow (under this section "Level 3 processing"), you can skip this step.

<br>

*In Linux:*

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force force-parameter /data/parameter_level3.txt LEVEL3`

`[sudo] password for GIS:` 

Output:
```
An empty parameter file skeleton was written to
  /data/parameter_level3.txt
Note that all parameters need to be given, even though some may not be used
with your specific parameterization.
Parameterize according to your needs and run with
force-higher-level /data/parameter_level3.txt
```
<br>

*In Windows:*

`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force force-parameter /home/docker/force/force/parameter_level3.txt LEVEL3`

<br>

### Step A.2: Create the output and other directories for level 3 processing

<br>

*In Linux:*

Create the output directory:<br>
`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force mkdir /data/dir_level3`

Create a provenance directory:<br>
`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force mkdir /data/dir_provenance_level3`

<br>

*In Windows:*

Create the output directory:<br>
`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force mkdir /home/docker/force/force/dir_level3`

Create a provenance directory:<br>
`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force mkdir /home/docker/force/force/dir_provenance_level3`

<br>

### Step A.3: Fill up the parameter file

Example files for both Linux and Windows can be found under the "Files" section of this component ("Level 3 processing"). Remove the suffix _Linux or _Windows from this file to use with this current workflow.

Note that the parameterisation is for Landsat imagery. If you are using Sentinel imagery, change the SENSORS in the parameter file to the following:
```
# SENSOR ALLOW-LIST
# ------------------------------------------------------------------------
.
.
.
SENSORS = SEN2A SEN2B SEN2C
.
.
.
```
### Step A.4: Run the level 3 processing module

The `force-higher-level` command is used to do level 3 processing, based on the parameterisation in Step A.1.

*In Linux:*

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force force-higher-level /data/parameter_level3.txt`

`[sudo] password for GIS:`

Output:
```
number of processing units: 480
 (active tiles: 48, chunks per tile: 10)
________________________________________
Progress:                        100.00%
Time for I/C/O:           037%/019%/044%
ETA:             00y 00m 00d 00h 00m 00s
________________________________________
________________________________________
Real time:       00y 00m 00d 00h 00m 32s
Virtual time:    00y 00m 00d 00h 01m 02s
Saved time:      00y 00m 00d 00h 00m 30s
Chunk ID:             -1      -1       9
________________________________________
Virtual I-time:  00y 00m 00d 00h 00m 23s
Virtual C-time:  00y 00m 00d 00h 00m 12s
Virtual O-time:  00y 00m 00d 00h 00m 27s

________________________________________
I-bound time:    00y 00m 00d 00h 00m 04s
C-bound time:    00y 00m 00d 00h 00m 00s
O-bound time:    00y 00m 00d 00h 00m 08s
________________________________________
data read    (uncompressed): 72.42 GB
data written (uncompressed): 11.68 GB
```

*In Windows:*

`podman run -it --user root -v "C:\Users\GIS:/home/docker/force" davidfrantz/force force-higher-level /home/docker/force/force/parameter_level3.txt`

Output:
```
Similar to the Linux output
```

<br>

## B. Time series analysis/Spectral Temporal Metrics

<br>

### Step B.1: Create the parameter file for level 3 processing

<br>

Example files for both Linux and Windows can be found under the "Files" section of this component ("Level 3 processing"). Remove the suffix _Linux or _Windows from this file to use with this current workflow.

<br>

*In Linux:*

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force force-parameter /data/parameter_tsa_spectral.prm TSA`

Output:
```
An empty parameter file skeleton was written to
  /data/parameter_tsa_spectral.prm
Note that all parameters need to be given, even though some may not be used
with your specific parameterization.
Parameterize according to your needs and run with
force-higher-level /data/parameter_tsa_spectral.prm
```

<br>
In Windows:

`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force force-parameter /home/docker/force/force/parameter_tsa_spectral.prm TSA`

<br>

### Step B.2: Create the output and other directories for level 3 processing

<br>

*In Linux:*

Create the output directory:<br>
`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force mkdir /data/dir_tsa`

Create a provenance directory:<br>
`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force mkdir /data/dir_provenance_tsa`

<br>

*In Windows:*

Create the output directory:<br>
`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force mkdir /home/docker/force/force/dir_tsa`

Create a provenance directory:<br>
`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force mkdir /home/docker/force/force/dir_provenance_tsa`

<br>

### Step B.3: Fill up the parameter file

<br>

**VERY IMPORTANT:** Change the number of threads according to your system capability. For example, if you running it in an system with 8 GB RAM, old processors like i3, and also not having any graphics card, best to start with 1, 1, and 1 for reading, computing and writing threads. 

It can be found under the following section

```
# PARALLEL PROCESSING
# ------------------------------------------------------------------------

NTHREAD_READ = 2
NTHREAD_COMPUTE = 4
NTHREAD_WRITE = 2
```
You should also edit other parameters to your requirements and limitations.

### Step B.4: Run the level 3 processing module

<br>

We will create two Spectral Temporal Metrics file parameters: one for the spectral indices and one for the vegetation indices such as NDVI. For more details, refer to [this tutorial in the official FORCE documentation][2]. As stated there, STM is important, and likely more useful than best-available pixel composites for the following reasons:

> "Compared to single observations, spectral-temporal metrics are able to
> increase model robustness across large areas as differences in
> acquisition dates across orbits has lower effects on the data.
> Spectral-temporal metrics are, in addition, able to represent
> phenological variation."

<br>

*In Linux:*

For spectral indices: <br>
`sudo docker run -it -v  /home/GIS/force:/data davidfrantz/force force-higher-level /data/parameter_tsa_spectral.prm`

Took around a minute to complete.

Output:
```
number of processing units: 480
 (active tiles: 48, chunks per tile: 10)
________________________________________
Progress:                        100.00%
Time for I/C/O:           014%/060%/027%
ETA:             00y 00m 00d 00h 00m 00s
________________________________________
________________________________________
Real time:       00y 00m 00d 00h 01m 44s
Virtual time:    00y 00m 00d 00h 02m 42s
Saved time:      00y 00m 00d 00h 00m 58s
Chunk ID:             -1      -1       9
________________________________________
Virtual I-time:  00y 00m 00d 00h 00m 22s
Virtual C-time:  00y 00m 00d 00h 01m 37s
Virtual O-time:  00y 00m 00d 00h 00m 43s

________________________________________
I-bound time:    00y 00m 00d 00h 00m 00s
C-bound time:    00y 00m 00d 00h 00m 59s
O-bound time:    00y 00m 00d 00h 00m 07s
________________________________________
data read    (uncompressed): 56.33 GB
data written (uncompressed): 11.06 GB

```
For vegetation indices: <br>
`sudo docker run -it -v  /home/GIS/force:/data davidfrantz/force force-higher-level /data/parameter_tsa_vegn.prm`

Took around 30 s to complete

Output:
```
number of processing units: 480
 (active tiles: 48, chunks per tile: 10)
________________________________________
Progress:                        100.00%
Time for I/C/O:           038%/045%/017%
ETA:             00y 00m 00d 00h 00m 00s
________________________________________
________________________________________
Real time:       00y 00m 00d 00h 00m 34s
Virtual time:    00y 00m 00d 00h 01m 04s
Saved time:      00y 00m 00d 00h 00m 30s
Chunk ID:             -1      -1       9
________________________________________
Virtual I-time:  00y 00m 00d 00h 00m 24s
Virtual C-time:  00y 00m 00d 00h 00m 29s
Virtual O-time:  00y 00m 00d 00h 00m 11s

________________________________________
I-bound time:    00y 00m 00d 00h 00m 04s
C-bound time:    00y 00m 00d 00h 00m 09s
O-bound time:    00y 00m 00d 00h 00m 01s
________________________________________
data read    (uncompressed): 56.33 GB
data written (uncompressed): 2.46 GB
```
<br>

*In Windows:*

For spectral indices: <br>
`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force force-higher-level /home/docker/force/force/parameter_tsa_spectral.prm`

For vegetation indices: <br>
`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force force-higher-level /home/docker/force/force/parameter_tsa_vegn.prm`

<br>

## Troubleshooting

In some cases, there are gaps in the tiles (some chunks/blocks are missing). See the gaps with light green below:

![enter image description here][3]

In those case, find the missing tiles by uploading (easier with drag-and-drop) all the files in QGIS, and finding the file name. 

Note that in Linux (Ubuntu 24.02 codename: noble), drag-and-drop will not work in QGIS for some reason. Therefore, I enabled wayland protocol since Xorg (X11) was not enabling drag-and-drop (enabled by logging out and then selecting the option from the bottom right). But, Wayland worsens QGIS functionality and will throw the warning:

```
Running QGIS in a Wayland session will result in a degraded experience due to limitations in the underlying Qt library and current versions of the Wayland protocol.
It is highly recommended that you switch to a traditional X11 session for an optimal user experience.
```
But for the time being, you can ignore the warning.

Finding the tile IDs of the ones with missing chunks can be done using the following steps:

a. Open the layer in QGIS

b. Ctrl+Shift+i > right-click on the image/tile(s) with missing chunk(s) (as seen in the case of a tile on the bottom left in the below image)

![enter image description here][4]

c. In the features panel, right-click on layer properties of that tile (see above).

The information section will show the 'Path' of this particular tile (see image below) and hence they can be used to trace the tile numbers. 

![enter image description here][5]

The blacked out portion is 'GIS' in my example workflow, but could be something else for you. X0002_Y0005 is the tile name in the example shown above.

Once the tile(s) with gaps have been identified, they alone can be rerun in the parameter file for tsa by specifying the tile numbers and the specific band. Most likely tiles of other bands in the same subfolder will have gaps. Check for them before doing it individually. The reprocessing of only selected tiles can be done with the help of a file allow-list ([see official FORCE documentation here][6]).

The tile allow-list (the path of which needs to be added in the appropriate place in the level 3 parameter file) will have the number of tiles to be reprocessed again, at the top line, followed by the tile IDs (one in each row, in no particular order):
```
3
X0001_Y0003
X0000_Y0001
X0002_Y0002
```

Make sure to delete any files named LOCK or .lock files from the folders where the rerun imagery is supposed to be added (one can also delete the existing files if required). Otherwise, the error “Unable to lock directory” will keep popping up (see below):

```
podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force force-higher-level /home/docker/force/force/parameter_tsa_spectral_partial.prm
number of processing units: 20
 (active tiles: 2, chunks per tile: 10)
________________________________________
Progress:                          5.00%
Time for I/C/O:        not available yet
ETA:                   not available yet
________________________________________
________________________________________
Progress:                         10.00%
Time for I/C/O:           001%/000%/099%
ETA:             00y 00m 00d 00h 22m 30s
________________________________________
________________________________________
Progress:                         15.00%
Time for I/C/O:           000%/000%/100%rce/force/dir_tsa_two/X0005_Y0003/ (timeout: 60s). Unable to loc
ETA:             00y 00m 00d 00h 31m 21s_tsa_two/X0005_Y0003/ (timeout: 60s). Unable to lock directory /
________________________________________5_Y0003/ (timeout: 60s). Unable to lock directory /home/docker/f
________________________________________eout: 60s). Unable to lock directory /home/docker/force/force/di
Progress:                         20.00%nable to lock directory /home/docker/force/force/dir_tsa_two/X00
Time for I/C/O:           000%/000%/100%rce/force/dir_tsa_two/X0005_Y0003/ (timeout: 60s). Unable to loc
ETA:             00y 00m 00d 00h 34m 20s_tsa_two/X0005_Y0003/ (timeout: 60s). Unable to lock directory /
________________________________________5_Y0003/ (timeout: 60s). Unable to lock directory /home/docker/f
________________________________________eout: 60s). Unable to lock directory /home/docker/force/force/di
Progress:                         25.00%nable to lock directory /home/docker/force/force/dir_tsa_two/X00
Time for I/C/O:           000%/000%/100%rce/force/dir_tsa_two/X0005_Y0003/ (timeout: 60s). Unable to loc
_________________________________________tsa_two/X0005_Y0003/ (timeout: 60s). Unable to lock directory /
Progress:                        100.00%5_Y0003/ (timeout: 60s). Unable to lock directory /home/docker/f
Time for I/C/O:           000%/000%/100%eout: 60s). Unable to lock directory /home/docker/force/force/di
ETA:             00y 00m 00d 00h 00m 00snable to lock directory /home/docker/force/force/dir_tsa_two/X00
________________________________________rce/force/dir_tsa_two/X0005_Y0003/ (timeout: 60s). Unable to loc
_________________________________________tsa_two/X0005_Y0003/ (timeout: 60s). Unable to lock directory /
Real time:       00y 00m 00d 00h 14m 32s5_Y0003/ (timeout: 60s). Unable to lock directory /home/docker/f
Virtual time:    00y 00m 00d 00h 14m 33seout: 60s). Unable to lock directory /home/docker/force/force/di
Saved time:      00y 00m 00d 00h 00m 01snable to lock directory /home/docker/force/force/dir_tsa_two/X00
Chunk ID:             -1      -1       9rce/force/dir_tsa_two/X0005_Y0003/ (timeout: 60s). Unable to loc
_________________________________________tsa_two/X0005_Y0003/ (timeout: 60s). Unable to lock directory /
Virtual I-time:  00y 00m 00d 00h 00m 01s5_Y0003/ (timeout: 60s). Unable to lock directory /home/docker/f
Virtual C-time:  00y 00m 00d 00h 00m 01seout: 60s).
Virtual O-time:  00y 00m 00d 00h 14m 31s

________________________________________
I-bound time:    00y 00m 00d 00h 00m 00s
C-bound time:    00y 00m 00d 00h 00m 01s
O-bound time:    00y 00m 00d 00h 14m 30s
________________________________________
data read    (uncompressed): 4.17 GB
data written (uncompressed): 686.65 MB
```

  [1]: https://force-eo.readthedocs.io/en/latest/howto/stm.html
  [2]: https://force-eo.readthedocs.io/en/latest/howto/lcf.html#data-aggregation-spectral-temporal-metrics
  [3]: https://i.ibb.co/FkfGMNf7/Screenshot-2025-04-07-105905.png
  [4]: https://i.ibb.co/JfZykyn/image.png
  [5]: https://i.ibb.co/Lz2hrWhx/edited-Screenshot-2025-09-18-202308.jpg
  [6]: https://force-eo.readthedocs.io/en/latest/components/higher-level/hl-aux.html#tile-allow-list
