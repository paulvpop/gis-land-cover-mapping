> Sampling is the procedure to extract the values that we computed
> using the STM or BAP procedure in the previous section, at the locations were
> we have collected training data in the first section. Then, these
> sampled points are used to create files for each class. This is then
> used in the next section as the input for training the models. 

See the [official FORCE documentation for sampling here][1].

<br>

- [Step A. Multi-class Sampling](#step-a-multi-class-sampling)
  * [Step A.1: Create sampling parameter file](#step-a1--create-sampling-parameter-file)
  * [Step A.2: Create the txt file containing the training data coordinates and class numbers](#step-a2--create-the-txt-file-containing-the-training-data-coordinates-and-class-numbers)
  * [Step A.3: Create directories for the parameterisation](#step-a3--create-directories-for-the-parameterisation)
  * [Step A.4: Run the program](#step-a4--run-the-program)
- [Step B. Creating sample files for individual classes](#step-b-creating-sample-files-for-individual-classes)
  * [Step B.1: Create the parameter file](#step-b1--create-the-parameter-file)
  * [Step B.2: Create an output folder for the non-synthetic mixtures](#step-b2--create-an-output-folder-for-the-non-synthetic-mixtures)
  * [Step B.3: Run the force-synthmix program](#step-b3--run-the-force-synthmix-program)
  * [Step B.4: Remove the first row containing the synthetic mixtures.](#step-b4--remove-the-first-row-containing-the-synthetic-mixtures)
- [Troubleshooting](#troubleshooting)
- [General information](#general-information)

<br>

## Step A. Multi-class Sampling

<br>

### Step A.1: Create sampling parameter file

<br>

Example files for both Linux and Windows can be found under the "Files" section of this component ("Sampling"). Remove the suffix _Linux or _Windows from this file to use with this current workflow.

<br>

*In Linux:*

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force force-parameter /data/parameter_sampling.prm SMP`

Output:
```
An empty parameter file skeleton was written to
  /data/parameter_sampling.prm
Note that all parameters need to be given, even though some may not be used
with your specific parameterization.
Parameterize according to your needs and run with
force-higher-level /data/parameter_sampling.prm
```

<br>

*In Windows:*

`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force force-parameter /home/docker/force/force/parameter_sampling.prm SMP`

Output:
```
Similar to Linux output
```
<br>

### Step A.2: Create the txt file containing the training data coordinates and class numbers

<br>

A text (.txt) file containing the coordinates of all the training data as well as numbers corresponding to each class should be prepared. Numbers are required as abbreviations or full names (alphabets) are not accepted by the program (for example, if the classes are grassland, water and forest, then they should be labelled as 1, 2 and 3, and not GR, WA, and FO).

<br>

**Option i** (Less time-consuming and more automated option)

**Step A.2.i.1:** For getting the txt file for the sampling parameterisation, first open the training data file (kmz format) that was created in Google Earth Pro (or online) in QGIS. 

**Step A.2.i.2:** 
```
Right click on the file > export > save as > Under layer options > Geometry > AS_XY > save
```

<br>

**Step A.2.i.3:** Run the following R script:
```
#Check the working directory
getwd()
#setwd by CTrl+Shift+H or setwd("C:/Users/GIS")

#Load the csv with coordinates and class abbreviations
samples <- read.csv("2024 training data.csv")

#View the files in the folder (optional):
list.files()

#View few lines of observations of main (optional):
head(samples)

#See the number of points per each class:

table(samples$Name)
#AGR  AJ  BA  BU  CC MGR  OF  SH  SS  TF  WA WRC 
# 54  27  33  22  46  14  28   7  59  28  23  57

#Load the dplyr package after installing (if necessary)
if (!require("dplyr")) install.packages("dplyr")
library(dplyr)

#Recode the names:
samples <- samples %>%
    select ("X","Y","Name") %>%
    mutate(Name = recode(Name,
                              "TF" = "1",
                              "OF" = "2",
                              "BA" = "3",
                              "CC" = "4",
                              "AJ" = "5",
                              "WRC" = "6",
                              "SH" = "7",
                              "BU" = "8",
                              "AGR" = "9",
                              "MGR" = "10",
                              "WA" = "11",
                              "SS"= "12"))

#If you want to filter out rows that containing any class, for example '11' (corresponding to the class of water) if they are not going to be modelled:
samples <- samples %>% filter(!grepl('11', Name))

#Delete the first row as column headers won't be used in the training file:
names(samples) <- NULL

#View a sample of the samples object:
head(samples)

#Check the class of the samples object:
class(samples)

#Save as a txt file:
write.table(samples, "samples_crlf.txt", quote = FALSE, row.names = FALSE)

#Since the write.table function saves the file with DOS/Windows newline (CRLF),
#it has to be converted to Unix newline (LF) for use in FORCE (no direct option
#to do that with write.table). Carry out the following to do that
#(Ref: https://stackoverflow.com/questions/25775894/transforming-an-r-script-from-dos-line-endings-to-unix):
Text = paste(readLines("samples_crlf.txt"), collapse="\n")
conx = file("samples.txt", open="wb")
write(Text, conx)
close(conx)
```

<br>

**Option ii** (More time-consuming and more manual option)

**Step A.2.ii.1:** For getting the txt file for the sampling parameterisation, first open the training data file (kmz format) that was created in Google Earth Pro (or online) in QGIS. 

**Step A.2.ii.2:** 
```
Right click on the file > export > save as as Comma Seperated Values [CSV] > Under layer options > Geometry > AS_XY > save
```
This will create a csv file of this format:
```
X	Y	Name	description	timestamp	begin	end	altitudeMode	tessellate	extrude	visibility	drawOrder	icon
95.14798926	28.43183089	FO						-1	0	-1		
95.03608788	28.55007659	FO						-1	0	-1		
95.08510659	28.65758374	FO						-1	0	-1		
95.07867343	28.41186578	FO						-1	0	-1		
95.24688396	28.36785526	FO						-1	0	-1		
95.00969171	28.50728016	FO						-1	0	-1		
95.11421818	28.3786144	GR						-1	0	-1		
95.24935949	28.37832109	GR						-1	0	-1		
95.26100573	28.43748175	GR						-1	0	-1		
95.07443679	28.55782849	GR						-1	0	-1		
95.17221602	28.56045985	GR						-1	0	-1		
```
<br>

**Step A.2.ii.3.** Recode the abbreviations to numbers:

You can use the following formula in some spreadsheet software to do the same :

Nested if formula (where C2 is the second row in the table and C is the third column 'Name' as seen above):

```
=IF(C2="GR",1,(IF( C2="WA",2),IF(C2="FO",3)))
````
You can also use formulas IFS for the same.

**Step A.2.ii.4:** Create a blank txt file:

<br>

*In Linux:*

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force touch /data/samples.txt`

<br>

*In Windows:*

`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force touch /home/docker/force/force/samples.txt`

**Step A.2.ii.5:** Change the EOL if the txt file was created in Windows. If in Linux, skip this step.

Open the file using Visual Studio Code or Notepadd ++ or other similar apps and change the EOL (End Of Line) formatting from CRLF (Windows style) to LF (Unix style).

**Step A.2.ii.6** Copy paste the coordinates and class numbers from the csv (fom step A.2.ii.3) to the txt file from the previous step.

<br>

### Step A.3: Create directories for the parameterisation

NOTE: Once the 'samples directory' is created in the following steps, the samples.txt file from the previous step should be copied there.

<br>

*In Linux:*

Create the output directory:<br>
`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force mkdir /data/dir_sampling`

Create the provenance directory (you just need to create this once):<br>
`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force mkdir /data/dir_provenance_sampling`

Create the samples directory:<br>
`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force mkdir /data/samples`

<br>

*In Windows:*

Create the output directory:<br>
`podman run -it --user root -v "C:\Users\GIS:/home/docker/force" davidfrantz/force mkdir /home/docker/force/force/dir_sampling`

Create the provenance directory (you just need to create this once):<br>
`podman run -it --user root -v "C:\Users\GIS:/home/docker/force" davidfrantz/force mkdir /home/docker/force/force/dir_provenance_sampling`

Create the samples directory:<br>
`podman run -it --user root -v "C:\Users\GIS:/home/docker/force" davidfrantz/force mkdir /home/docker/force/force/samples`

<br>

### Step A.4: Run the program

<br>

*In Linux:*

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force force-higher-level /data/parameter_sampling.prm`

`[sudo] password for GIS:`

Output:

```
number of processing units: 480
 (active tiles: 48, chunks per tile: 10)
________________________________________
Progress:                        100.00%
Time for I/C/O:           038%/062%/000%
ETA:             00y 00m 00d 00h 00m 00s
________________________________________
________________________________________
Real time:       00y 00m 00d 00h 00m 14s
Virtual time:    00y 00m 00d 00h 00m 21s
Saved time:      00y 00m 00d 00h 00m 07s
Chunk ID:             -1      -1       9
________________________________________
Virtual I-time:  00y 00m 00d 00h 00m 08s
Virtual C-time:  00y 00m 00d 00h 00m 13s
Virtual O-time:  00y 00m 00d 00h 00m 00s

________________________________________
I-bound time:    00y 00m 00d 00h 00m 00s
C-bound time:    00y 00m 00d 00h 00m 05s
O-bound time:    00y 00m 00d 00h 00m 00s
________________________________________
data read    (uncompressed): 13.52 GB
```
<br>

*In Windows:*

`podman run -it --user root -v "C:\Users\GIS:/home/docker/force" davidfrantz/force force-higher-level /home/docker/force/force/parameter_sampling.prm`

Output:
```
number of processing units: 480
 (active tiles: 48, chunks per tile: 10)
________________________________________
Progress:                        100.00%
Time for I/C/O:           067%/033%/000%
ETA:             00y 00m 00d 00h 00m 00s
________________________________________
________________________________________
Real time:       00y 00m 00d 00h 00m 21s
Virtual time:    00y 00m 00d 00h 00m 30s
Saved time:      00y 00m 00d 00h 00m 09s
Chunk ID:             -1      -1       9
________________________________________
Virtual I-time:  00y 00m 00d 00h 00m 20s
Virtual C-time:  00y 00m 00d 00h 00m 10s
Virtual O-time:  00y 00m 00d 00h 00m 00s

________________________________________
I-bound time:    00y 00m 00d 00h 00m 10s
C-bound time:    00y 00m 00d 00h 00m 00s
O-bound time:    00y 00m 00d 00h 00m 00s
________________________________________
data read    (uncompressed): 13.52 GB
```

<br>

## Step B. Creating sample files for individual classes

Now that have sampling files for all the classes combined, we can create them for individual classes. For this purpose, I have improvised on an existing module within FORCE that is actually used to create synthetic mixtures. See the [tutorial for the same in the official FORCE documentation][2]. First, we will using the program for creating synthetic mixtures, restricting the number of synthetic mixtures to just one row. And then, we will delete that row. This way, we get the sample files for each class without any synthetic mixtures.

<br>

### Step B.1: Create the parameter file

<br>

*In Linux:*

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force force-parameter /data/parameter_synth.prm SYNTHMIX`

Output:
```
An empty parameter file skeleton was written to
  /data/parameter_synth.prm
Note that all parameters need to be given, even though some may not be used
with your specific parameterization.
Parameterize according to your needs and run with
force-synthmix /data/parameter_synth.prm
```
<br>

*In Windows:*

`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force force-parameter /home/docker/force/force/parameter_synth.prm SYNTHMIX`

Output:
```
Similar to Linux
```

<br>

### Step B.2: Create an output folder for the non-synthetic mixtures

<br>

Create an output folder for the files containing the NON-synthetic mixtures + one 1 row of synthetic mixtures:

<br>

*In Linux:*

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force mkdir /data/no_mixtures`

<br>

*In Windows:*

`podman run -it --user root -v "C:\Users\GIS:/home/docker/force" davidfrantz/force mkdir /home/docker/force/force/no_mixtures`

`--user root` is used when there are permission issues.

<br>

### Step B.3: Run the force-synthmix program

<br>

*In Linux:*

`sudo docker run -it -v /home/GIS/force:/data davidfrantz/force force-synthmix /data/parameter_no_synth.prm`

<br>

*In Windows:*

`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force force-synthmix /home/docker/force/force/parameter_no_synth.prm`

This will result in a folder containing files like this:
![enter image description here][3]

Barring the first row, the FEATURES files will all have the same values (the STM or BAP values for the respective training data coordinates), like the following:
```
2039.0 6353.0 6803.0 2202.0 6714.0 7562.0 2130.0 6412.0 7090.0 3328.0 6506.0 6701.0 3486.0 6465.0 6834.0 2412.0 6784.0 7264.0 3172.0 6663.0 6995.0 3264.0 6538.0 6946.0 560.0 1225.0 4698.0 460.0 643.0 4127.0 1170.0 1156.0 6959.0 3066.0
-9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0 -9999.0
705.0 1184.0 1231.0 424.0 700.0 786.0 570.0 900.0 978.0 1855.0 2007.0 2070.0 1965.0 2206.0 2294.0 1026.0 1525.0 1554.0 1342.0 1742.0 1805.0 1582.0 1961.0 2020.0 1992.0 2004.0 2658.0 1351.0 1360.0 1697.0 783.0 322.0 5453.0 1232.0
```
The above example only has three rows, despite it looking like more number of rows. This is because those three rows contain 34 values each. In the previous section

But  RESPONSE files show 1 for the class of interest and 0 for other classes (see below):
```
1.0
1.0
0.0
```
<br>

### Step B.4: Remove the first row containing the synthetic mixtures.

<br>

**WARNING: USE VERY CAREFULLY AS IT CAN DELETE THE FIRST LINES OF EVERY TXT FILES IN YOUR SYSTEM IF THE DIRECTORY IS NOT PROPERLY SPECIFIED**

<br>

*In Linux:*

`sudo docker run -it --user root -v /home/GIS/force:/data davidfrantz/force sh -c "cd /data/no_mixtures && sed -i '1d' *.txt"`

Explanation:

`podman run -it` runs the container interactively (-it) <br>
`--user root` ensures you have permissions to modify files.<br>
`-v /home/GIS/force:/data` mounts the folder `/home/GIS/force` to `data` in the container.<br>
`davidfrantz/force` is the container image being used.

The ones above are usual arguments that we have used so far.
The following are new:<br>
`sh` runs a shell command inside the container.<br>
`cd /data/no_mixtures` navigates to the mounted directory.<br>
`sed -i '1d' *.txt` removes the first line/row (1d) from all the .txt files in-place (-i). **WARNING: USE THIS VERY CAREFULLY**

<br>

*In Windows:*

`podman run -it --user root -v "C:\Users\GIS:/home/docker/force" davidfrantz/force sh -c "cd /home/docker/force/force/no_mixtures && sed -i '1d' *.txt"`

<br>

## Troubleshooting

<br>

*Example A*

When running the following:
`podman run -it -v "C:\Users\GIS:/home/docker/force" davidfrantz/force force-synthmix parameter_synth.prm`
it gave an error of
```
“Unable to open parameter file!
Reading parameter file failed!”
```
This is because the full path for the parameter file is not specified. So, always keep the full path. i.e. `/home/docker/force/force/parameter_synth.prm`

<br>

*Example B*

If the TARGET_CLASS parameter has an extra class number which is not there in the samples.txt files, it will give the following error:

“parameter TARGET_CLASS must be a subset of parameter CLASSES.
Reading parameter file failed!”

So, make sure that the numbers match.

<br>

## General information

If you turn off the PRETTY PROGRESS option (=FALSE) in any of the parameter files (not just this section), the following happens:

![pretty-progress-off][4]

So, pretty progress is a cleaner option.


  [1]: https://force-eo.readthedocs.io/en/latest/components/higher-level/smp/index.html#sampling
  [2]: https://force-eo.readthedocs.io/en/latest/howto/lcf.html#synthetically-mixed-training-data
  [3]: https://i.ibb.co/jPqXD4GV/image.png
  [4]: https://i.ibb.co/mr5TYjcZ/image.png
